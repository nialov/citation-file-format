name: testing

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:

  tests:
    name: test (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-latest', 'macos-latest', 'windows-latest']
        python-version: ['3.8', '3.9']
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Python info
      shell: bash -l {0}
      run: |
        which python3
        python3 --version
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip setuptools wheel poetry pre-commit
        python3 -m pip install -r requirements.txt
    # TODO: Some tests seem to require files from specific github urls that do not exist anymore?
    - name: Run pytest
      run: pytest -k 'not 1.1.0'
    - name: Install with poetry
      run: poetry install
    - name: Test entrypoint
      run: |
        poetry run validate-citation-file-format --help
        poetry run validate-citation-file-format CITATION.cff
    - name: Test pre-commit-hook with valid CITATION.cff
      run: |
        pre-commit try-repo . --files CITATION.cff
    - name: Test entrypoint with simple expected failure
      run: |
        echo "this does not belong here." >> CITATION.cff
        poetry run validate-citation-file-format CITATION.cff && exit 1 || exit 0
    - name: Test pre-commit-hook with simple expected failure
      # windows does not have exit command
      shell: bash -l {0}
      run: |
        pre-commit try-repo . --files CITATION.cff && exit 1 || exit 0
